%% Create Faster R-CNN Object Detection Network
% This example builds upon the <docid:vision_ug#mw_51a5e174-51f2-4da8-892b-16d3ce2278e2 
% Create Fast R-CNN Object Detection Network> example above. It transforms a pretrained 
% ResNet-50 network into a Faster R-CNN object detection network by adding an 
% ROI pooling layer, a bounding box regression layer, and a region proposal network 
% (RPN). The Faster R-CNN network can then be trained using |trainFasterRCNNObjectDetector|.
%% Create Fast R-CNN Network
% Start by creating Fast R-CNN, which forms the basis of Faster R-CNN. The <docid:vision_ug#mw_51a5e174-51f2-4da8-892b-16d3ce2278e2 
% Create Fast R-CNN Object Detection Network> example explains this section of 
% code in detail.  

% Load a pretrained ResNet-50.
net = resnet50;
lgraph = layerGraph(net);

% Remove the the last 3 layers. 
layersToRemove = {
    'fc1000'
    'fc1000_softmax'
    'ClassificationLayer_fc1000'
    };
lgraph = removeLayers(lgraph, layersToRemove);

% Specify the number of classes the network should classify.
numClasses = 105;
numClassesPlusBackground = numClasses + 1;

% Define new classification layers.
newLayers = [
    fullyConnectedLayer(numClassesPlusBackground, 'Name', 'rcnnFC')
    softmaxLayer('Name', 'rcnnSoftmax')
    classificationLayer('Name', 'rcnnClassification')
    ];

% Add new object classification layers.
lgraph = addLayers(lgraph, newLayers);

% Connect the new layers to the network. 
lgraph = connectLayers(lgraph, 'avg_pool', 'rcnnFC');

% Define the number of outputs of the fully connected layer.
numOutputs = 4 * numClasses;

% Create the box regression layers.
boxRegressionLayers = [
    fullyConnectedLayer(numOutputs,'Name','rcnnBoxFC')
    rcnnBoxRegressionLayer('Name','rcnnBoxDeltas')
    ];

% Add the layers to the network.
lgraph = addLayers(lgraph, boxRegressionLayers);

% Connect the regression layers to the layer named 'avg_pool'.
lgraph = connectLayers(lgraph,'avg_pool','rcnnBoxFC');

% Select a feature extraction layer.
featureExtractionLayer = 'activation_40_relu';

% Disconnect the layers attached to the selected feature extraction layer.
lgraph = disconnectLayers(lgraph, featureExtractionLayer,'res5a_branch2a');
lgraph = disconnectLayers(lgraph, featureExtractionLayer,'res5a_branch1');

% Add ROI max pooling layer.
outputSize = [14 14];
roiPool = roiMaxPooling2dLayer(outputSize,'Name','roiPool');
lgraph = addLayers(lgraph, roiPool);

% Connect feature extraction layer to ROI max pooling layer.
lgraph = connectLayers(lgraph, featureExtractionLayer,'roiPool/in');

% Connect the output of ROI max pool to the disconnected layers from above.
lgraph = connectLayers(lgraph, 'roiPool','res5a_branch2a');
lgraph = connectLayers(lgraph, 'roiPool','res5a_branch1');

%% Add Region Proposal Network (RPN)
% Faster R-CNN uses a region proposal network (RPN) to generate region proposals. 
% An RPN produces region proposals by predicting the class, ¡§object¡¨ or ¡§background¡¨, 
% and box offsets for a set of predefined bounding box templates known as "anchor 
% boxes". Anchor boxes are specified by providing their size, which is typically 
% determined based on a priori knowledge of the scale and aspect ratio of objects 
% in the training dataset. 
% 
% Define the anchor boxes and create a |regionProposalLayer|.

% Define anchor boxes.
anchorBoxes = [
    77    82

    82    87

    47    37

    76    51

    90    38

    59    41

    49    49

    45    36

    54    33

    65    48

    84    87

    65    49

    57    47

    69    44

    62    30

    38    38

    38    36

    59    48

    67    58

    56    39

    60    50

    82    39

    88    83

    59    50

    67    50

    85    43

    50    41

    77    48

    92    38

    48    56

    59    53

    67    45

    59    50

    65    57

    65    49

    62    40

    45    36

    80    41

    66    40

    65    33

    60    44

    83    41

    86    41

    60    50

    56    48

    93    37

    83    36

    76    49

    56    50

    56    40

    64    50

    58    39

    61    54

    53    37

    69    28

    64    45

    65    49

    64    60

    73    29

    92    36

    93    37

    59    57

    59    40

    93    36

    77    42

    51    35

    63    41

    38    36

    83    37

    55    39

    65    50

    91    40

    51    34

    57    36

    59    29

    60    51

    87    88

    87    41

    94    34

    65    48

    77    45

    66    60

    66    41

    64    44

    65    42

    59    51

    90    83

    66    48

    54    34

    58    52

    82    36

    64    47

    49    35

    66    33

    61    49

    80    49

    54    43

    66    33

    56    54

    53    33

    82    36

    64    48

    52    36

   104    94

    59    51

    92    35

    54    38

    80    91

    73    30

    59    51

    88    30

    55    27

    59    41

    66    50

    59    48

    85    40

    65    27

    58    42

    82    36

    91    40

    56    48

    95    44

    62    55

    45    33

    93    40

    62    48

    87    36

    83    42

    57    44

    90    37

    59    47

    57    26

    47    35

    56    31

    66    52

    49    56

    56    47

    89    36

    65    51

    57    51

    58    48

    59    49

    81    95

    66    49

    96    39

    55    52

    76    39

    56    46

    70    97

    59    41

    60    47

    82    40

    48    46

    75    99

    65    48

    65    50

    49    32

    64    41

    94    43

    88    32

    60    53

    57    32

    49    40

    85    84

    91    88

    92    41

    65    49

    96    36

    56    40

    72    29

    63    32

    58    41

    79    41

    54    35

    79    49

    56    38

    89    37

    94    40

    58    30

    67    38

    62    41

    85    39

    78    49

    86    84

    58    47

    60    36

    37    31

    84    85

    93    40

    84    43

    93    44

    90    35

    67    42

    63    40

    66    32

    89    35

    58    27

    55    36

    84    35

    74    97

    74    98

    61    45

    58    41

    60    43

    66    51

    66    40

    82    40

    57    50

    57    48

    54    39

    47    34

    52    29

    61    28

    66    43

    84    41

    59    48

    58    48

    47    36

    61    52

    89    38

    88    34

    59    40

    69    34

    74    99

    88    30

    70    53

    92    43

    67    33

    63    33

    53    37

    91    34

    85    39

    59    37

    72    29

    81    90

    52    32

    94    35

    82    50

    66    46

    74    99

    66    48

    54    50

    47    38

    90    37

    85    86

    66    49

    84    89

    64    36

    59    49

    48    53

    82    84

    67    44

    66    39

    59    38

    53    36

    78    51

    68    33

    85    86

    89    38

    92    34

    67    43

    54    37

    58    48

    78    47

    57    53

    65    40

    73    38

    59    50

    58    47

    61    45

    71    44

    83    85

    63    40

    85    98

    55    52

    54    39

    59    40

    49    56

    65    48

    96    41

    98    50

    75   102

    66    45

    57    47

    59    49

    54    49

    45    35

    38    34

    54    36

    48    53

    65    48

    81    38

    82    91

    80    47

    73    41

    64    52

    57    48

    37    35

    78    84

    58    25

    47    35

    82    86

    52    36

    54    41

    65    41

    51    36

    45    35

    67    38

    58    40

    56    50

    66    45

    66    56

    61    49

    82    37

    53    37

    57    40

    58    29

    66    48

    66    54

    81    52

    96    41

    69    36

    58    40

    72    98

    66    41

    68    42

    55    40

    53    27

    81    35

    98    89

    56    40

    68    40

    66    29

    68    42

    85    36

   100    48

    77    43

    84    53

    66    40

    48    41

    82    51

    86    81

    44    36

    68    39

    83    35

    45    34

    83    39

    59    48

    53    29

    77    52

    58    47

    77    48

    49    56

    65    33

    57    42

    58    54

    79    86

    59    37

    63    41

    60    48

    56    49

    55    40

    61    41

    68    57

    59    51

    94    38

    38    36

    66    49

    68    48

    53    32

    51    53

    67    43

    63    47

    55    39

    83    39

    66    26

    60    48

    93    35

    83    87

    85    89

    75    99

    89    36

    84    41

    68    53

    60    39

    80    41

    66    33

    59    40

    74    40

    54    27

    89    35

    90    33

    88    31

    58    49

    92    40

    61    43

    73    29

    68    51

    65    49

    95    35

    53    37

    77    81

    45    36

    63    36

    87    33

    65    53

    49    50

    58    39

    83    85

    60    47

    57    54

    79    45

    66    42

    59    39

    85    54

    56    47

    59    49

    62    49

    65    51

    52    41

    66    52

    63    41

    89    34

    54    42

    89    24

    67    29

    89    37

    83    50

    66    40

    56    48

    82    38

    80    84

    76    51

    83    39

    57    38

    76    48

    46    37

    58    41

    58    45

    59    48

    60    49

    37    36

    47    33

    60    48

    41    40

    56    50

    89    83

    94    34

    62    26

    60    53

    74   100

    93    37

    88    33

    90    35

    88    82

    62    34

    59    48

    83    46

    83    49

    66    34

    65    40

    65    49

    61    44

    86    48

    56    39

    94    36

    85    44

    59    43

    62    53

    56    46

    83    42

    81    86

    47    53

    68    34

    54    40

    93    37

    39    34

    77   101

    82    43

    74    99

    64    48

    91    40

    55    51

    52    41

    38    34

    47    37

    72    31

    46    36

    45    35

    62    40

    46    34

    74    99

    86    56

    57    41

    60    31

    51    43

    81    37

    56    39

    65    33

    64    47

    81    36

    63    50

    63    49

    68    41

    63    40

    55    42

    55    50

    61    58

    64    46

    81    55

    66    47

    64    41

    93    39

    65    45

    81    47

    89    34

    95    41

    57    49

    63    47

    78    43

    73    97

    55    49

    66    29

    63    35

    74    98

    49    40

    56    41

    75    47

    51    53

    59    40

    95    43

    60    51

    86    50

    63    52

    53    33

    52    33

    66    40

    57    48

    63    39

    62    41

    57    46

    59    53

    74    99

    67    43

    52    28

    66    27

    85    38

    75    99

    93    53

    74    99

    61    45

    90    36

    81    36

    78    39

    58    49

    89    36

    68    41

    55    28

    94    35

    84    43

    59    52

    74    98

    83    51

    47    36

    66    59

    80    84

    66    33

    67    50

    64    48

    78    88

    74    35

    89    39

    76   103

    74    99

    63    49

    63    42

    87    31

    57    33

    58    44

    58    43

    84    48

    58    48

    98    89

    59    40

    54    38

    56    47

    65    52

    72    41

    58    46

    59    40

    62    54

    86    43

    67    52

    59    53

    53    39

    47    36

    60    50

    89    37

    59    35

    59    49

    57    30

    76    84

    49    45

    74    99

    57    41

    60    50

    89    55

    63    42

    58    32

    57    39

    74    97

    65    47

    94    44

    66    43

    83    49

    67    43

    83    39

    93    41

    68    36

    71    28

    74    99

   101    88

    58    39

    91    36

    57    38

    73   100

    54    35

    68    35

    67    34

    48    37

    56    41

    67    42

    63    50

    69    27

    66    39

    74    99

    92    38

    59    40

    78    84

    78    47

    58    51

    51    36

    58    38

    58    40

    64    34

    54    38

    84    42

    76    46

    65    50

    99    49

    58    40

    79    84

    63    48

    80    50

    64    51

    59    48

    59    47

    76    82

    76    50

    65    48

    83    41

    57    49

    60    52

    59    40

    96    41

    75    98

    59    40

    85    49

    94    37

    61    41

    60    51

    95    30

    56    49

    61    30

    84    86

    52    37

    73    98

    58    44

    69    35

    62    55

    76    87

    70    36

    66    30

    90    41

    63    53

    84    40

    67    40

    90    38

    81    85

    80    47

    90    41

    82    41

    39    38

    65    50

    65    52

    59    36

    82    34

    86    40

    67    39

    77    41

    88    51

    66    49

    65    47

    56    39

    83    44

    93    34

    84    88

    64    48

    60    46

    67    52

    62    28

    87    89

    59    48

    83    40

    62    28

    39    36

    71    39

    84    89

    83    42

    78    52

    74    98

    79    48

    68    37

    62    32

    56    49

    64    41

    57    28

    59    43

    88    30

    82    47

    65    44

    53    48

    66    33

    97    90

   100    44

    65    59

    73    29

    56    29

    59    45

    80    48

    60    50

    55    31

    66    49

    67    35

    91    37

    57    58

    65    33

    62    38

    61    52

    90    38

    58    49

    65    52

    40    40

    51    41

    88    35

    94    92

    56    34

    75    99

    59    50

    59    51

    83    48

    93    38

    69    45

    59    48

    53    26

    65    45

    61    54

    83    39

    58    48

    60    42

    76    47

    66    26

    77    82

    56    38

    59    44

    57    34

    56    28

    46    34

    74   100

    76   100

    66    49

    83    49

    81    37

    80    49

    82    48

    57    38

    98    48

    75    99

    60    49

    90    39

    59    44

    66    35

    64    48

    59    40

    67    47

    67    50

    59    48

    50    47

    65    48

    65    50

    83    42

    59    49

    39    39

    57    36

    56    49

    48    49

    66    34

    50    25

    99    91

    87    42

    65    41

    84    41

    56    37

    64    56

    62    48

    63    49

    78    51

    94    36

    88    82

    53    29

    90    39

    92    38

    77    50

    48    39

    57    48

    47    35

    53    39

    66    47

    54    36

    62    45

    80    89

    74    99

    84    50

    57    26

    85    36

    46    46

    65    48

    59    28

    52    37

    57    39

    86    39

    89    52

    59    38

    59    52

    65    48

    73    36

    59    48

    62    43

    82    40

    63    42

    70    40

    64    48

    79    43

    85    39

    66    42

    93    37

    62    56

    58    39

    58    28

    52    48

    56    39

    83    35

    62    49

    53    37

    66    58

    65    43

    77    40

    50    57

    75   100

    76   101

    58    49

    66    48

    89    35

    61    46

    56    39

    92    32

    81    53

    65    28

    77    55

    66    49

    61    49

    64    46

    63    41

    80    37

    67    41

    78    52

    53    53

    53    38

    62    48

    66    41

    60    50

    60    50

    55    39

    86    83

    57    28

    92    36

    58    43

    58    25

    74    98

    65    54

    73    99

    83    47

    57    55

    49    56

    94    37

    67    38

    56    39

    67    43

    92    36

    84    42

    65    48

    82    86

    56    42

    84    41

    65    34

    65    51

    91    41

    60    42

    81    85

    65    32

    65    49

    66    41

    79    90

    51    55

    81    88

    61    50

    70    40

    81    50

    64    36

    45    35

    57    52

    63    49

    59    50

    53    35

    92    35

    68    41

    89    32

    66    34

    60    51

    66    54

    83    40

    62    50

    63    33

    96    39

    54    33

    65    49

    60    52

    57    49

    46    34

    65    43

    99    88

    64    38

    65    51

    68    47

    58    47

    65    49

    77    40

    94    39

    49    38

    60    49

    65    41

    89    34

    65    49

    53    47

    99    42

    62    47

    62    48

    50    44

    62    42

    60    51

    88    37

    66    40

    68    36

   100    48

    66    52

    71    50

    51    39

    57    36

    47    36

    58    36

    68    52

    53    55

    66    34

    59    37

    61    52

    59    54

    58    39

    77   102

    89    37

    60    50

    66    48

    57    47

    63    52

    83    47

    49    51

    81    37

    80    32

    64    48

    65    41

    61    48

    67    28

    63    40

    61    53

    64    31

   101    99

    90    39

    60    45

    68    37

    54    47

    47    54

    38    34

    91    37

    67    52

    57    51

    57    53

    70    31

    84    87

    66    51

    60    31

    58    47

    75   102

    74    99

    57    49

    57    53

    68    34

    64    49

    88    36

    59    54

    60    48

    65    39

    84    37

    94    34

    83    47

    64    48

    95    42

    88    49

   103   104

    57    52

    90    37

    63    41

    59    37

    66    41

    56    33

    62    47

    53    38

    65    50

    66    48

    45    36

    81    79

    53    34

    61    31

    89    30

    66    53

    59    41

    84    48

    84    37

    65    50

    83    41

    67    29

    73    98

    67    59

    93    41

    59    39

    52    35

    85    86

    60    42

    62    29

    57    25

    75   100

   100    92

    84    36

    95    36

    92    33

    77    49

    82    88

    75    98

    88    35

    66    56

    89    32

    93    36

    79    48

    61    47

    54    45

    89    38

    79    47

    53    36

    90    37

    73    39

    55    47

    75   100

    67    26

    61    48

    58    54

    74    98

    64    48

    53    38

    55    40

    60    53

    83    37

    48    44

    89    38

    57    53

    62    48

    65    49

    73    98

    66    42

    47    35

    55    47

    67    38

    60    54

    56    29

    84    95

    52    34

    64    34

    55    57

    47    36

    95    41

    68    37

    90    35

    73    32

    71    47

    57    50

    55    55

    60    50

   100    84

    58    50

    84    55

    84    38

    90    40

    59    50

    52    33

    80    35

    64    47

    81    86

    65    36

    92    38

    72    37

    76    50

    65    58

    59    52

    59    36

    85    47

    60    51

    81    49

    92    37

    55    44

    66    52

    89    34

    59    50

    64    49

    57    49

    59    51

    39    40

    82    37

    67    55

    53    38

    90    36

    56    48

    56    36

    60    43

    66    26

    54    36

    82    48

    64    43

    92    37

    77    50

    64    38

    82    47

    77    41

    54    57

    83    87

    88    36

    58    29

    59    56

    61    50

    54    33

    67    49

    49    38

    45    34

    57    48

    64    43

    53    34

    45    34

    65    48

    65    52

    58    48

    71    35

    58    32

    56    54

    59    48

    67    51

    50    43

    82    49

    74    97

    83    36

    66    42

    62    50

    66    38

    73    98

    55    41

    63    49

    49    45

    60    33

    79    88

    90    39

    85    53

    50    51

    56    36

    61    48

    59    46

    57    49

    56    32

    66    40

    64    40

    45    34

    60    39

   100    52

    57    50

    58    52

    53    33

    65    28

    90    34

    65    57

   105   139

    64    52

    95    41

    50    25

    73    98

    90    36

    62    32

    66    46

    83    35

    69    29

    53    39

    47    48

    58    49

    77    48

    47    38

    56    54

    58    41

    54    39

    94    36

    62    40

    52    55

    93    39

    57    61

    56    52

    58    41

    86    38

    98    88

    66    48

    89    37

    66    48

    49    56

    89    36

    58    52

    59    48

    74    39

    83    47

    58    34

    60    49

    82    37

    64    41

    83    56

    82    35

    47    36

    75    99

    65    41

    90    36

    57    52

    62    58

    89    34

    61    43

    66    49

    96    40

    65    52

    37    35

    61    32

    86    38

    89    83

    58    35

    66    41

    81    40

    84    49

    51    35

    67    50

    80    98

    60    51

    88    31

    66    42

    69    35

    51    38

    56    32

    66    47

    37    34

    57    54

    66    48

    52    26

    57    46

    90    39

    45    35

    62    49

    80    39

    56    47

    75    81

    98    46

    51    37

    55    51

    61    42

    93    43

    78    51

    83    88

    89    31

    57    37

    92    42

    56    36

    88    49

    59    48

    83    48

    74    98

    96    51

    59    43

    65    42

    47    36

    59    48

    87    50

    53    34

    63    44

    60    47

    38    32

    58    49

    65    54

    67    40

    46    35

    53    29

    94    33

    84    44

    85    35

    60    39

    67    49

    58    27

    74    97

    72    35

    56    38

    84    40

    63    49

    84    51

    94    36

    56    48

    93    43

    60    31

    66    41

    78    49

    94    40

    78    55

    83    80

    64    49

    65    48

    48    36

    84    44

    70    41

    60    53

    52    45

    58    48

    74    97

    61    48

   101    89

    64    52

    59    47

    65    41

    65    40

    59    50

    58    42

    84    88

    63    48

    65    46

    59    52

    89    81

    47    36

    53    39

    47    35

    64    49

    92    35

    62    48

    68    49

    66    32

    83    48

    54    42

    92    37

    60    51

    73    39

    57    47

    57    49

    80    91

    65    41

    53    38

    84    90

    46    34

    60    47

    71    36

    66    49

    93    38

    84    46

    57    34

    59    48

    64    57

    59    47

    74    99

    72    26

    73    34

    44    35

    65    27

    66    52

    59    47

    94    37

    58    31

    58    49

    64    51

    74    98

    57    52

    55    35

    56    41

    71    40

    83    48

    56    42

    57    55

    64    42

    58    51

    47    35

    50    34

    66    52

    47    37

    67    53

    60    50

    66    47

    72    31

    92    82

    45    39

    66    51

    63    51

    57    48

    82    37

    53    41

    47    36

    37    34

    58    39

    60    41

    49    40

    58    47

    75    45

    47    46

    58    50

    82    34

    65    54

    83    36

    59    49

    82    49

    84    47

    59    43

    62    40

    69    33

    95    39

   102    99

    81    35

    94    34

    63    50

    49    40

   100    89

    67    56

    61    57

    60    52

    53    44

    56    51

    66    55

    65    47

    57    56

    57    54

    78    39

    78    52

    59    50

    59    49

    53    29

    83    90

    89    36

    84    39

    96    88

    89    36

    73    97

    86    40

    57    49

    59    40

    47    53

    47    37

    56    41

    60    47

    74   100

    74   100

    47    35

    68    27

    82    85

    67    60

    56    39

    58    28

    68    52

    90    34

    84    39

    56    29

    86    90

    56    39

    93    33

    88    37

    66    35

    58    49

    53    39

    85    45

    65    47

    78    51

    56    51

    66    48

    56    38

    48    44

    59    31

    80    85

    66    40

    59    49

    56    40

    82    50

    92    40

    53    37

    60    49

    57    54

    92    37

    60    50

    64    50

    82    40

    79    85

    67    49

    92    34

    53    35

    75    83

    90    36

    68    41

    66    52

    93    34

    58    55

    46    34

    68    48

    67    35

    87    39

    65    47

    74    99

    73    99

    74   100

    84    87

    82    93

    66    50

    96    39

    94    36

    66    50

    59    55

    83    78

    72    30

    60    52

    92    35

    66    41

    77   101

    47    34

    67    49

    64    53

    95    51

    63    38

    71    36

    66    32

    61    25

    90    35

    97    49

    66    41

    66    46

    59    50

    82    37

    59    53

    82    35

    74    99

    99    47

    80    51

    73    98

    65    46

    73    97

    67    39

    65    40

    65    32

    85    86

    58    47

    58    47

    66    34

    64    55

    59    48

    67    34

    94    36

    70    54

    63    48

    60    40

    66    30

    95    46

    66    50

    53    27

    99    51

    87    38

    66    32

    55    34

    64    40

    65    48

    64    51

    81    88

    59    57

    59    42

    74    99

    57    49

    86    46

    48    55

    62    53

    72    42

    60    44

    60    43

    83    38

    59    49

    65    48

    58    33

    77    50

    66    33

    59    49

    72    40

    74    98

    57    39

    93    35

    54    37

    62    39

    40    37

    44    36

    58    53

    58    31

    87    34

    66    51

    84    40

    63    35

    49    56

    56    30

    54    38

    37    34

    66    60

    61    46

    47    53

    74    39

    54    52

    83    88

    53    37

    58    44

    85    41

    62    51

    59    49

    66    40

    63    40

    67    43

    65    40

    59    27

    54    46

    57    29

    60    52

    63    40

    67    59

    60    49

    53    45

    91    36

    56    38

    74    99

    89    35

    63    41

    94    34

    63    38

    57    26

    55    54

    67    53

    61    49

    87    34

    66    49

    86    39

    53    40

    87    47

    64    42

    56    39

    81    36

    66    43

    53    39

    78    48

    66    50

    59    49

    81    48

    61    50

    71    35

    66    33

    63    48

    68    62

    51    44

    61    50

    40    39

    63    48

    65    58

    56    47

    64    32

    62    35

    56    48

    78    40

    73    98

    89    35

    81    85

    48    38

    60    47

    93    40

   100    42

    95    36

    95    88

    49    55

    56    32

    62    47

    60    51

    60    51

    58    32

    94    54

    57    41

    82    49

    55    40

    76    40

    82    33

    63    33

    64    49

    61    48

    54    38

    57    34

    65    52

    66    41

    83    51

    50    34

    59    49

    95    37

    91    88

    65    41

    80    36

    89    36

    64    48

    85    32

    82    34

    65    50

    90    33

    88    32

    68    46

    65    49

    84    46

    56    34

    65    30

    64    55

    59    48

    66    40

    83    48

    58    37

    91    41

    81    37

    68    43

    82    40

    61    47

    62    53

    46    37

    89    50

    74    98

    82    89

    45    34

   103   105

    91    38

    65    48

   101    98

    59    50

    76    48

    81    48

    58    47

    65    51

    93    32

    82    39

    52    35

    58    33

    74    97

    53    33

    66    43

    68    41

    62    57

    59    53

    57    50

    59    47

    62    26

    64    43

    59    48

    64    52

    59    40

    79    88

    68    31

    72    38

    61    51

    50    38

    56    60

    64    49

    96    37

    62    48

    64    56

    67    44

    67    42

    84    37

    61    40

    82    48

    82    35

    54    34

    56    49

    79    42

    92    33

    78    40

    89    36

    63    48

    64    52

    59    50

    66    44

    50    36

    55    53

    81    89

    74    49

    99    50

    59    47

    55    43

    47    53

    88    35

    55    49

    59    50

    57    54

    50    49

    82    49

    56    40

    88    37

    55    29

    83    50

    73    98

    45    37

    63    48

    78    83

    66    63

    58    27

    58    51

    57    40

    60    45

    64    48

    83    48

    62    57

    73    98

    88    34

    38    36

    67    48

    90    37

    45    36

    61    32

    64    38

   101    97

    53    28

    59    48

    91    36

    60    49

    66    44

    59    50

    59    41

    84    47

    59    50

    60    49

    79    44

    45    33

    67    42

    90    83

    83    50

    64    49

    67    62

    77    78

    67    38

    59    40

    63    48

    66    49

    81    48

    59    47

    63    49

    92    36

    53    51

    57    31

    87    94

    72    36

    96    48

    83    42

    52    26

    67    42

    84    50

    66    33

    63    53

    89    35

    57    49

    61    45

    54    35

    86    39

    65    46

    60    44

    92    32

    63    40

    87    34

    55    47

    92    35

    90    39

    97    90

    52    39

    38    35

    61    46

    79    86

    92    38

    62    52

    65    53

    56    55

    53    39

    66    42

    63    48

    81    37

    75    99

    67    31

    64    51

    68    43

    52    35

    59    49

    53    35

    65    47

    57    48

    83    49

    68    61

    60    54

    89    84

    66    52

    61    47

    84    32

    90    37

    56    47

    65    49

    60    49

    67    57

    64    48

    55    30

    68    41

    62    48

    48    56

    90    38

    81    53

    59    42

    52    35

    50    49

    87    39

    93    35

    55    52

    62    48

    65    48

    94    39

    64    35

    62    47

    65    48

    52    33

    49    48

    47    50

    51    35

    64    53

    58    30

    90    41

    71    34

    54    48

    66    42

    58    49

    84    86

    61    50

    66    43

    64    40

    55    53

    59    44

    59    47

    64    60

    66    53

    57    50

    65    48

    58    47

    94    37

    66    47

    95    39

    65    51

    55    49

    94    49

    65    43

    60    52

    98    40

    64    49

    89    83

    58    41

    58    44

    55    37

    60    39

    68    40

    47    38

    66    48

    64    48

    45    34

    65    40

    65    40

    84    41

    83    84

    55    44

    91    39

   101    98

    91    36

    46    35

    66    49

    52    37

    46    37

    57    56

    53    28

    82    43

    66    51

    49    52

    89    35

    59    44

    63    48

    58    52

    59    40

    67    58

    68    44

   100    43

    89    34

    83    81

    54    39

    63    40

    73    99

    73    27

    60    50

    56    48

    67    41

   100    41

    46    36

    94    33

    65    55

    56    49

   101    91

    70    37

    82    51

    79    40

    84    37

    59    32

    65    50

    98    86

    62    49

    58    48

    96    37

    37    34

    54    52

    66    39

    59    47

    75    40

    68    36

    66    42

    66    47

    66    49

    81    42

    86    41

    47    36

    80    84

    78    49

    74    48

    64    49

    59    48

    65    40

    65    35

    46    34

    63    40

    77    52

    89    35

    75    99

    74    99

    50    37

    53    36

    59    52

    64    48

    49    47

    74    82

    50    39

    57    35

    54    39

    78    92

    47    35

    59    48

    58    28

    59    40

    59    48

    65    42

    60    51

    83    88

    64    40

    67    64

    50    41

    71    38

    89    36

    64    48

    59    29

    47    35

    93    32

    73    96

    76    88

    79    49

    57    48

    56    29

    66    57

    63    49

    84    43

    91    34

    66    58

    94    37

    60    50

    62    32

    66    49

    59    55

    65    49

    82    86

    79    46

    66    42

    44    35

    56    42

    58    31

    66    48

    57    41

    85    40

    60    48

    59    31

    45    37

    90    37

    88    39

    67    44

    65    47

    49    34

    64    48

    56    40

    50    34

    67    28

    66    61

    77    81

    65    50

    49    36

    47    37

    66    49

    60    42

    62    52

    69    53

    74    98

    71    38

    63    52

    57    39

    59    54

    81    84

    57    44

    65    39

    72    29

    61    50

    60    50

    70    28

    64    49

    74    98

    57    41

    69    30

    68    34

    71    37

    72    44

    56    42

    63    51

    59    47

    66    43

    56    50

    64    42

    63    52

    66    41

    59    41

    58    49

    60    51

    89    40

   103    89

    64    48

    57    47

    65    40

    61    50

    79    32

    73    77

    59    47

    93    37

    90    39

    57    51

    61    40

    84    49

    70    27

    82    80

    59    49

    75   101

    66    51

    50    35

    57    48

    96    41

    80    49

    87    37

    68    36

    57    37

    57    39

    55    50

    81    48

    47    38

    66    39

    60    50

    66    49

    68    27

    63    38

    87    36

    59    58

    85    93

    58    36

    62    50

    71    27

    84    40

    65    48

    59    40

    54    37

    60    40

    90    40

    82    37

    94    38

    63    48

    85    38

    64    47

    64    50

    82    38

    84    41

    46    36

    92    41

    77    39

    49    39

    61    47

    62    48

    66    41

    57    29

    64    43

    88    32

    88    32

    58    37

    95    35

    80    36

    62    34

    59    37

    60    50

    57    43

    66    49

    90    39

    74    76

    67    43

    70    25

    52    42

    93    37

    89    34

    57    52

    53    37

    75    99

    54    30

    66    59

    63    41

    51    34

    57    48

    58    39

    89    36

    72    36

    66    51

    52    39

    83    79

    64    40

    88    37

    62    54

    59    49

    72    37

    58    51

    63    45

    55    38

    59    42

    86    40

    64    42

    64    50

   104    95

    64    47

    56    46

    61    52

    82    32

    47    37

    83    50

    63    50

    56    41

    65    28

    57    50

    66    36

    66    50

    64    48

    61    45

    91    32

    78    48

    74   100

    87    89

    66    48

    59    50

    59    49

    53    35

    94    40

    73    29

    65    40

    65    51

    47    49

    58    40

    56    39

    66    50

    74    99

    96    39

    58    52

    60    51

    61    50

   100    95

    45    32

    57    40

    64    41

    52    34

    86    48

    75    48

    54    42

    60    47

    54    48

    68    57

    55    52

    65    48

    56    30

    77    48

    66    30

    47    36

    65    47

    76    43

    80    50

    82    88

    91    37

    92    39

    59    41

    66    40

    65    50

    56    49

    53    36

    84    40

    49    39

    44    34

    63    48

    94    89

    84    39

    77   100

    44    35

    60    43

    51    42

    54    31

    55    35

    56    51

    88    36

    83    39

    55    41

    84    41

    82    85

    58    48

    68    36

    63    40

    66    40

    57    47

    64    40

    85    40

    52    55

    89    37

    83    41

    53    39

    82    39

    64    32

    94    37

    55    37

    73    33

    68    50

    56    40

    81    48

    89    37

    72    29

    57    43

    64    48

    59    41

    53    48

    59    47

    56    54

    38    36

    49    33

    90    37

    81    33

    74   100

    54    39

    85    91

    63    40

    75   101

    62    48

    99    49

    95    34

    49    38

    59    42

    57    48

    52    51

    61    27

    66    60

    85    89

    84    36

    92    38

    49    56

    76    46

    66    43

    58    47

    99    90

    70    40

    88    38

    58    40

    58    41

    59    52

    59    39

    45    33

    50    31

    73    98

    56    40

    48    39

    68    33

    72    99

    66    40

    66    50

    58    47

    61    53

    89    33

    95    40

    57    41

    60    50

    63    48

    46    38

    66    50

    63    40

    63    41

    90    37

    50    53

    60    49

    75   100
    ];

% Create the region proposal layer.
proposalLayer = regionProposalLayer(anchorBoxes,'Name','regionProposal');

lgraph = addLayers(lgraph, proposalLayer);
%% 
% 
% 
% Add the convolution layers for RPN and connect it to the feature extraction 
% layer selected above. 

% Number of anchor boxes.
numAnchors = size(anchorBoxes,1);

% Number of feature maps in coming out of the feature extraction layer. 
numFilters = 1024;

rpnLayers = [
    convolution2dLayer(3, numFilters,'padding',[1 1],'Name','rpnConv3x3')
    reluLayer('Name','rpnRelu')
    ];

lgraph = addLayers(lgraph, rpnLayers);

% Connect to RPN to feature extraction layer.
lgraph = connectLayers(lgraph, featureExtractionLayer, 'rpnConv3x3');
%% 
% 
% 
% Add the RPN classification output layers. The classification layer classifies 
% each anchor as "object" or "background".

% Add RPN classification layers.
rpnClsLayers = [
    convolution2dLayer(1, numAnchors*2,'Name', 'rpnConv1x1ClsScores')
    rpnSoftmaxLayer('Name', 'rpnSoftmax')
    rpnClassificationLayer('Name','rpnClassification')
    ];
lgraph = addLayers(lgraph, rpnClsLayers);

% Connect the classification layers to the RPN network.
lgraph = connectLayers(lgraph, 'rpnRelu', 'rpnConv1x1ClsScores');
%% 
% 
% 
% Add the RPN regression output layers. The regression layer predicts 4 box 
% offsets for each anchor box.

% Add RPN regression layers.
rpnRegLayers = [
    convolution2dLayer(1, numAnchors*4, 'Name', 'rpnConv1x1BoxDeltas')
    rcnnBoxRegressionLayer('Name', 'rpnBoxDeltas');
    ];

lgraph = addLayers(lgraph, rpnRegLayers);

% Connect the regression layers to the RPN network.
lgraph = connectLayers(lgraph, 'rpnRelu', 'rpnConv1x1BoxDeltas');

%% 
% 
% 
% Finally, connect the classification and regression feature maps to the 
% region proposal layer inputs, and the ROI pooling layer to the region proposal 
% layer output.

% Connect region proposal network.
lgraph = connectLayers(lgraph, 'rpnConv1x1ClsScores', 'regionProposal/scores');
lgraph = connectLayers(lgraph, 'rpnConv1x1BoxDeltas', 'regionProposal/boxDeltas');

% Connect region proposal layer to roi pooling.
lgraph = connectLayers(lgraph, 'regionProposal', 'roiPool/roi');

% Show the network after adding the RPN layers.
figure
plot(lgraph)
ylim([30 42])
%% 
% The network is ready to be trained using |trainFasterRCNNObjectDetector|.
% 
% _Copyright 2018 The MathWorks, Inc._